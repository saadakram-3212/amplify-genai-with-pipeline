name: Full Stack Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: read
  actions: read

jobs:
  deploy-iac:
    name: Deploy Infrastructure
    permissions:
      contents: read
    uses: ./.github/workflows/iac-deploy.yml
    with:
      environment: ${{ inputs.environment }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-backend:
    name: Deploy Backend
    needs: deploy-iac
    permissions:
      contents: read
      actions: read
    uses: ./.github/workflows/backend.yml
    with:
      environment: ${{ inputs.environment }}
      skip_artifact_download: true
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    permissions:
      contents: read
    uses: ./.github/workflows/docker-frontend.yml
    with:
      environment: ${{ inputs.environment }}
      skip_artifact_download: true
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-iac, deploy-backend, deploy-frontend]
    steps:
      - name: Print Deployment Summary
        run: |
          echo "âœ… Full stack deployment completed successfully!"