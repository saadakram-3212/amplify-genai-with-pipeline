name: Full Stack Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy-iac:
    name: Deploy Infrastructure
    uses: ./.github/workflows/iac-deploy.yml
    with:
      environment: ${{ inputs.environment }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy-backend:
    name: Deploy Backend
    needs: deploy-iac
    uses: ./.github/workflows/backend.yml
    with:
      environment: ${{ inputs.environment }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  deploy-frontend:
    name: Deploy Frontend
    needs: deploy-backend
    uses: ./.github/workflows/docker-frontend.yml
    with:
      environment: ${{ inputs.environment }}
      ecr_repo: ${{ needs.deploy-iac.outputs.tf_outputs && fromJSON(needs.deploy-iac.outputs.tf_outputs).ecr_repository_name.value || format('amplify-frontend-{0}', inputs.environment) }}
      ecs_cluster: ${{ needs.deploy-iac.outputs.tf_outputs && fromJSON(needs.deploy-iac.outputs.tf_outputs).ecs_cluster_name.value || format('amplify-cluster-{0}', inputs.environment) }}
      ecs_service: ${{ needs.deploy-iac.outputs.tf_outputs && fromJSON(needs.deploy-iac.outputs.tf_outputs).ecs_service_name.value || format('amplify-service-{0}', inputs.environment) }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-iac, deploy-backend, deploy-frontend]
    steps:
      - name: Print Deployment Summary
        run: |
          echo "Full stack deployment completed successfully!"
          echo ""