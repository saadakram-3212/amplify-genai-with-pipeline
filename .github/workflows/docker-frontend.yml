name: Frontend Docker Build & Push

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev or prod)"
        required: true
        type: choice
        options:
          - dev
          - prod
      ecr_repo:
        description: "ECR repository name"
        required: true
        type: string
      ecs_cluster:
        description: "ECS cluster name"
        required: true
        type: string
      ecs_service:
        description: "ECS service name"
        required: true
        type: string

  workflow_call:
    inputs:
      environment:
        description: "Environment (dev or prod)"
        required: true
        type: string
      ecr_repo:
        description: "ECR repository name"
        required: true
        type: string
      ecs_cluster:
        description: "ECS cluster name"
        required: true
        type: string
      ecs_service:
        description: "ECS service name"
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
    outputs:
      image_tag:
        description: "Docker image tag"
        value: ${{ jobs.build.outputs.image_tag }}
      full_image:
        description: "Full ECR image URL"
        value: ${{ jobs.build.outputs.full_image }}

jobs:
  build:
    name: Build, Push & Deploy
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.set_outputs.outputs.image_tag }}
      full_image: ${{ steps.set_outputs.outputs.full_image }}

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "ENVIRONMENT=${{ inputs.environment }}" >> $GITHUB_ENV
          echo "ECR_REPO=${{ inputs.ecr_repo }}" >> $GITHUB_ENV
          echo "ECS_CLUSTER=${{ inputs.ecs_cluster }}" >> $GITHUB_ENV
          echo "ECS_SERVICE=${{ inputs.ecs_service }}" >> $GITHUB_ENV

      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
          aws configure set region "$AWS_REGION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Docker Image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: ./amplify-genai-frontend
          push: true
          tags: |
            ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${{ github.sha }}
            ${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set Output Variables
        id: set_outputs
        run: |
          echo "image_tag=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "full_image=${{ steps.ecr.outputs.registry }}/${{ env.ECR_REPO }}:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Force new deployment of ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --force-new-deployment \
            --region $AWS_REGION

      - name: Wait for ECS service stability
        run: |
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} \
            --region $AWS_REGION
